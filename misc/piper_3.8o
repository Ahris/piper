# Chip8 is a virtual machine designed in 1977 for programming video games.
# Octo is a high level assembler, disassembler and simulator for Chip8.
# Click 'Run' and then press ASWD to move the sprite around the screen.
# Click the Octo logo for source, documentation and examples.

###########################################
#
#  Assets and Data
#
###########################################

:const bird_max_x 56
:const bird_max_y 25

:alias wave-timer v7
:alias hide       v8
:alias bird-state v9
:alias lock       va
:alias score      vb
:alias px         vc
:alias py         vd

# Note that ve is used as a temp register for comparisons
# vf is used by CHIP8 to report collisions.
# Wikipedia states that vf = 1 if a a screen pixel is flipped,
# and 0 otherwise. But, I think Octo actually just increments it.
:alias collision vf

# Goodies data ({alive=1, dead=0}, x, y)
: star_data    1 0 0
: dollar_data  1 0 0
: shell_data   1 0 0
: swirl_data   1 0 0
: swirl-2_data 1 0 0
: swirl-3_data 1 0 0

: star
    0x20 0xF8 0x70 0x50 0x00 0x00 0x00 0x00

: dollar
    0x70 0xA8 0xD8 0xA8 0x70 0x00 0x00 0x00

: shell
    0x70 0xD8 0xD8 0x70 0x20 0x00 0x00 0x00

: swirl
    0x70 0xD8 0x88 0x70 0x00 0x20 0x00 0x00

: swirl-2
    0x18 0x2C 0xD6 0x1C 0x00 0x00 0x00 0x00

: swirl-3
    0x78 0xFC 0xCC 0xB4 0x2C 0x00 0x00 0x00

: bird-0
    0x0E 0x9D 0xFE 0xF4 0x4C 0x38 0x10 0x00

: bird-1
    0x00 0x0E 0x9D 0xFE 0x74 0x4C 0x38 0x00

: bird-2
    0x00 0x80 0xFC 0xF6 0x4F 0x3F 0x00 0x00

# Wave data (tile height, offset x, offset y, num rows) # (offset x, offset y, pixel height)
: wave-data-1-5 15 0 0  1      #  0 0  9
: wave-data-2   15 0 10 1      # 10 0 13
: wave-data-3   15 0 16 1      # 16 0 15
: wave-data-4   9  0 5  2      #  5 0 18 -> round to multiple of 16 that fits on the screen

: wave-1-5
0b00000000 0b00001000 0b00010000 0b00010000 0b00111000 0b11111100 0b11111111 0b01111111 0b00011111 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00010000 0b00001010 0b00001011 0b00011111 0b00111111 0b11111111 0b11111111 0b11111110 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00010001 0b00011111 0b00111111 0b11111111 0b11111111 0b11100000 0b10000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b11111111 0b11111111 0b11111111 0b11111111 0b11110000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00011000 0b11111100 0b11111111 0b11111111 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00111111 0b01111111 0b11111111 0b11111111 0b00000001 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b10000000 0b11000000 0b11100001 0b11111111 0b11111111 0b00011111 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b11100000 0b11100000 0b11110000 0b11111000 0b11111111 0b11111111 0b00011111 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000 0b00000000

: wave-2
0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x04 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x04 0x50 0x44 0x02 0x00 0x00 0x00 0x00 0x24 0x52 0x44 0x22 0x00 0x00 0x40 0x02 0x26 0x7A 0x6C 0x24 0x28 0x40 0x41 0x02 0x37 0xFE 0x7C 0x14 0x28 0xC4 0x41 0x86 0x3F 0xFF 0xFC 0x1C 0x30 0x44 0x41 0xFF 0x7F 0xFF 0xFE 0x7C 0x20 0x6C 0x43 0xFF 0xFF 0x00 0x1F 0xFC 0x20 0xFC 0x67 0xFF 0xE0 0x00 0x01 0xFE 0x60 0xFE 0xFF 0xF8 0x00 0x00 0x00 0x1F 0xF1 0xFF 0xFF 0xC0 0x00 0x00 0x00 0x03 0xFF 0x1F 0xFC 0x00 0x00 0x00 0x00 0x00 0x7F 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00

: wave-3
0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03 0xFC 0x00 0x00 0x00 0xFF 0x00 0x0F 0x8C 0x00 0x00 0x0F 0x00 0x00 0x00 0x00 0x70 0x00 0x00 0x00 0xF0 0x0F 0xFE 0x00 0x0E 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x7F 0xF0 0x3E 0x00 0x00 0x00 0x00 0x00 0x80 0x0C 0xC1 0x83 0x00 0x03 0xC7 0x01 0x00 0x03 0x00 0x7E 0x0F 0xCC 0x00 0xC0 0x80 0x04 0x00 0xC0 0x70 0x38 0x00 0x20 0x60 0x38 0x03 0x00 0x80 0x04 0x00 0x7F 0xFF 0xFF 0x0C 0x00 0x00 0x03 0x00 0xFF 0xFF 0xFF 0xF8 0x00 0x00 0x07 0xFF 0xFF 0xFF 0xFF 0xFF 0xE0 0xE0 0xFF 0xFF 0x80 0x00 0x07 0xFF 0xE0 0xFF 0xFF 0xC0 0x00 0x00 0x00 0x0F 0xFF 0x1F 0xFC 0x00 0x00 0x00 0x00 0x00 0x7F 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00

: wave-4
0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x03 0xE0 0x00 0x00 0x00 0x00 0x00 0x00 0x04 0x10 0x00 0x00 0x03 0xE8 0x00 0x00 0x00 0x00 0x03 0x83 0xC4 0x01 0xC0 0x00 0x01 0xC0 0x04 0x40 0x00 0x18 0x00 0x00 0x02 0x24 0x04 0x51 0x81 0xA4 0x03 0x43 0x82 0x2A 0x04 0x52 0x42 0x62 0x04 0x44 0x42 0x13 0xC4 0x52 0x44 0x22 0x04 0x54 0x4E 0x12 0x24 0x52 0x44 0x23 0x88 0x6C 0x52 0x12 0x24 0x52 0x44 0x22 0x48 0x44 0x52 0x12 0x26 0x7A 0x6C 0x24 0x28 0x44 0x7E 0x32 0x37 0xFE 0x7C 0x14 0x28 0xC5 0x43 0x36 0x3F 0xFF 0xFC 0x1C 0x30 0x46 0xC3 0xFF 0x7F 0xFF 0xFE 0x7C 0x20 0x6C 0x43 0xFF 0xFF 0x00 0x1F 0xFC 0x20 0xFC 0x67 0xFF 0xE0 0x00 0x01 0xFE 0x60 0xFE 0xFF 0xF8 0x00 0x00 0x00 0x1F 0xF1 0xFF 0xFF 0xC0 0x00 0x00 0x00 0x03 0xFF 0x1F 0xFC 0x00 0x00 0x00 0x00 0x00 0x7F 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00

###########################################
#
#  Game Logic
#
###########################################

: main
    spawn-goodies
    spawn-bird
    wave-timer := 180
    delay := wave-timer

    loop
        clear
        move-bird
        update-goodies

    vf := delay
        wave-timer += vf
        if wave-timer >= 180 begin
            draw-waves
            wave-timer := 0
            spawn-goodies
        end

        # lock the framerate of this program via the delay timer:
        loop
           lock := delay
           if lock != 0 then
        again

        lock := 10
        delay := lock
    again
;

: random-xy
    px := random 0b0001111
    py := random 0b0001111
;

###########################################
#
#  Birdy Logic
#
###########################################

: spawn-bird
    random-xy
    i := bird-0
    sprite px py 8
;

: move-bird
    # Update its position, and redraw bird

    # keyboard W
    v0 := 5
    if v0 key begin
        if py > 0 then py += -1
    end

    # keyboard S
    v0 := 8
    if v0 key begin
        if py < bird_max_y then py += 1
    end

    # keyboard A
    v0 := 7
    if v0 key begin
        if px > 0 then px += -1
    end

    # keyboard D
    v0 := 9
    if v0 key begin
        if px < bird_max_x then px +=  1
    end

    # keyboard E - hide
    v0 := 6
    if v0 key begin
    hide := 1
    else
    hide := 0
    end

    draw-bird
;

: draw-bird
    if hide == 0 begin
        i := bird-0
        if bird-state == 0 begin
            i := bird-1
        end
        vf := 1
        bird-state ^= vf
    else
        i := bird-2
    end

    sprite px py 8
;

###########################################
#
#  Goodies Logic
#
###########################################

: spawn-goodies
    random-xy
    i := star
    sprite px py 8
    v0 := 1 v1 := px v2 := py
    i := star_data save v2

    random-xy
    i := shell
    sprite px py 8
    v1 := px v2 := py
    i := shell_data save v2

    random-xy
    i := dollar
    sprite px py 8
    v1 := px v2 := py
    i := dollar_data save v2

    random-xy
    px += 32
    i := swirl
    sprite px py 8
    v1 := px v2 := py
    i := swirl_data save v2

    random-xy
    px += 32
    i := swirl-2
    sprite px py 8
    v1 := px v2 := py
    i := swirl-2_data save v2
;

: update-goody
    # Goody is already picked up
    if v0 == 0 then return

    # Draw the goody
    sprite v1 v2 8

    # Can't pick up goodie while hidden
    if hide == 1 then return

    # Erase goody on collision
    if collision == 1 begin
        sprite v1 v2 8
        draw-bird
        v0 := 0 # Goody is collected
        score += 1
    end
;

: update-goodies
    i := star_data   load v2 i := star   update-goody i := star_data   save v0
    i := dollar_data load v2 i := dollar update-goody i := dollar_data save v0
    i := shell_data  load v2 i := shell  update-goody i := shell_data  save v0
    i := swirl_data  load v2 i := swirl  update-goody i := swirl_data  save v0
    i := swirl-2_data load v2 i := swirl-2 update-goody i := swirl-2_data save v0
;

###########################################
#
#  Wave Logic
#
###########################################

: draw-wave
    # v0 sprite stride
    # v1 sprite x
    # v2 sprite y
    loop
        sprite v1 v2 15
        i  += v0
        v1 += 8
        if v1 == 64 then return
    again
;

: draw-waves
    clear
    i := wave-data-1-5 load v2 i := wave-1-5 draw-wave # draw
    i := wave-data-1-5 load v2 i := wave-1-5 draw-wave # erase
    # i := wave-2   draw-wave
    # i := wave-2   draw-wave
    # i := wave-3   draw-wave
    # i := wave-3   draw-wave
    # i := wave-4   draw-wave
    # i := wave-4   draw-wave
    # i := wave-1-5 draw-wave
    # i := wave-1-5 draw-wave
;
